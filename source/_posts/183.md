---
title: 指数加权平均
categories: 机器学习
tags: 机器学习
mathjax: true
date: 2018-05-21 15:32:15
---

假设我们有一组数据，记录的是半年内伦敦市的每天的气温（单位采用华氏温标），我们还根据这组数据得到了一张散点图，横坐标代表天数（第几天），纵坐标代表温度（华氏温标）。具体情况如下图所示：
![数据和散点图](/img/exponentially_weighted_averages_1.png)


## 如何得到近半年的气温整体变化趋势
基于这组数据我们想要得到半年内的气温整体变化趋势。我们可以如下处理：

首先我们假设 $V_0 = 0$，也就是认为第 0 天的气温为 0 华氏度。接下来我们用以下公式计算得到每天的气温：
$$
V_1 = 0.9V_0 + 0.1 \theta_1 \\
V_2 = 0.9V_1 + 0.1 \theta_2 \\
\vdots \\
V_{181} = 0.9V_{180} + 0.1 \theta_{181}
$$

然后我们将得到的 $V_1, V_2, \dots, V_{181}$ 在散点图中标出并用红色实现连接起来，这条红色实现代表的就是半年内的气温整体变化趋势，得到的图片如下图所示：
![近半年气温变化趋势](/img/exponentially_weighted_averages_2.png)

## 这样做的本质是什么？
我们将 $V_{100} = 0.9V_{99} + 0.1 \theta_{100}$ 展开：
$$
\begin{aligned}
V_{100}
=& 0.9V_{99} + 0.1 \theta_{100} \\
=& 0.9(0.9V_{98} + 0.1 \theta_{99}) + 0.1 \theta_{100} \\
=& 0.9^2 V_{98} + 0.1 \times 0.9 \theta_{99} + 0.1 \theta_{100} \\
=& 0.9^2 (0.9V_{97} + 0.1 \theta_{98}) + 0.1 \times 0.9 \theta_{99} +  0.1 \theta_{100}\\
=& 0.9^3V_{97} + 0.1 \times 0.9^2 \theta_{98} + 0.1 \times 0.9 \theta_{99} +  0.1 \theta_{100}\\
\vdots \\
=& 0.1 \theta_{100} + 0.1 \times 0.9 \theta_{99} + 0.1 \times 0.9^2 \theta_{98} + \dots + 0.1 \times 0.9^{99} \theta_1 
\end{aligned}
$$

我们可以看到每天气温的权值随着天数的向前推移而以指数形式递减，越近的天数，对应的权重越大。我们就将这样的加权平均叫做**指数加权平均**，我们可以得出指数加权平均的递推公式的一般形式：
$$
V_t = \beta V_{t-1} + (1 - \beta) \theta_t
$$

下图中的绿线为 $\beta = 0.98$ 时得到的表示温度变化趋势的线，而图中的黄线表示的时 $\beta = 0.5$ 时得到的表示温度变化趋势的线。
![温度变化趋势](/img/exponentially_weighted_averages_3.png)

我们发现黄色线好像要比绿色线“更剧烈”、“更实时”。这也反映了一个客观事实，就是当 $\beta$ 取值更小的时候，得到的温度变化趋势线就“更加的实时”。其实 $\beta$ 决定了加权平均的天数。比如当 $\beta = 0.9$ 时，则 $\frac{1}{1-\beta} = 10$，表示将前 10 天进行指数加权平均。可是我们在刚刚的推导过程中明明发现当前的气温跟之前所有天的气温都有关系啊？怎么能说是前 10 天的指数加权平均呢？

根据之前的公式推导可以看出来，指数部分是衰减的，一般认为当这个指数部分衰减到 $\frac{1}{e}$ 就可以忽略不计了。所以我们只要证明：
$$
\beta ^ {\frac{1}{1-\beta}} = \frac{1}{e}
$$

就可以了。

$$
令 \; \frac{1}{1 - \beta} = N, \; N > 0 \\
则 \; \beta = 1 - \frac{1}{N}, \; \frac{1}{N} < 1
$$

所以我们证明出下式成立即可：
$$
(1-\frac{1}{N})^N = \frac{1}{e}
$$

当 $N >> 0$ 时，上式成立。所以我们也就粗略的证明了当 $\beta = 0.9$ 时，表示将前 10 天进行指数加权平均这类问题。

## 偏移校正
带偏移校正的指数加权平均的一般形式为：
$$
V_t = \frac{\beta V_{t-1} + (1 - \beta) \theta_t}{1 - \beta^t}
$$

如果不做偏移校正，在一些点（特别是像上文中的 $V_1，V_2, V_3,\dots$）的结果是不准确的。上文中提到当 $\beta=0.98$ 时，指数加权平均结果如下图绿色曲线所示。但是实际上，真实曲线如紫色曲线所示。
![偏移校正](/img/exponentially_weighted_averages_4.png)

我们注意到，紫色曲线与绿色曲线的区别是，紫色曲线开始的时候相对较低一些。这是因为开始时我们设置 $V_0=0$，所以初始值会相对小一些，直到后面受前面的影响渐渐变小，趋于正常。

修正这种问题的方法是进行偏移校正，在上文中已经指出了带偏移校正的指数加权平均的一般形式，我们可以发现式子中的 $1 - \beta^t$ 小于 1，并且越在开始的点，这个值越小，我们就可以将 $V_t$ 修正的更大一些。效果就是把紫色曲线的开始部分向上提升一些，与绿色线重合。随着 $t$ 的增大，$1 - \beta^t$ 也逐渐增大，慢慢的会得到 $1 - \beta^t \approx 1$，紫色线和绿色线依然重合。

值得一提的是，机器学习中，偏移校正并不是必须的。因为，在一次次迭代后，最终 $V_t$ 受初始值影响微乎其微，紫色曲线与绿色曲线基本重合。一般可以忽略初始迭代过程。

## 参考
1. 深度学习工程师微专业 —— 吴恩达
2. [吴恩达《优化深度神经网络》精炼笔记（2）-- 优化算法](https://mp.weixin.qq.com/s?__biz=MzIwOTc2MTUyMg==&mid=2247483958&idx=1&sn=78ed60b5035ef77ad07d1b2c5e61da57&chksm=976fa7aba0182ebd5271b00dfe78f74c1be88ce286ec59c3d79cbb68b10f10051b36dbb727ec&scene=21#wechat_redirect)

